<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permission Persistence Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Permission Persistence Fix Test</h1>
        <p>This test verifies that permission changes are properly saved to the database and persist after page refresh.</p>
        
        <div class="test-section info">
            <h3>ğŸ“‹ Test Instructions</h3>
            <ol>
                <li>Login to the application (admin/admin123)</li>
                <li>Go to Administrator â†’ Permissions tab</li>
                <li>Toggle a permission (e.g., Finance Executive â†’ NCD Series â†’ View)</li>
                <li>Refresh the page</li>
                <li>Check if the permission change persisted</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>ğŸ” API Tests</h3>
            <button onclick="testLogin()">1. Test Login</button>
            <button onclick="testGetPermissions()">2. Get Current Permissions</button>
            <button onclick="testTogglePermission()">3. Toggle Test Permission</button>
            <button onclick="testVerifyPersistence()">4. Verify Persistence</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š Test Results</h3>
            <div id="log" class="log">Ready to run tests...\n</div>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ Expected Behavior</h3>
            <ul>
                <li>âœ… Permission changes should be saved to the database immediately</li>
                <li>âœ… Changes should persist after page refresh</li>
                <li>âœ… Backend API should return updated permissions</li>
                <li>âœ… Frontend should load permissions from backend on startup</li>
            </ul>
        </div>
    </div>

    <script>
        let authToken = null;
        let originalPermissions = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'ğŸ”„';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = 'Log cleared...\n';
        }

        async function testLogin() {
            log('Testing login...');
            try {
                const response = await fetch('http://localhost:8000/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    log('Login successful! Token obtained.', 'success');
                    return true;
                } else {
                    log(`Login failed: ${response.status} ${response.statusText}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`Login error: ${error.message}`, 'error');
                return false;
            }
        }

        async function testGetPermissions() {
            if (!authToken) {
                log('Please login first!', 'error');
                return;
            }

            log('Getting current permissions...');
            try {
                const response = await fetch('http://localhost:8000/permissions/', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const permissions = await response.json();
                    originalPermissions = permissions;
                    
                    log(`Permissions loaded successfully! Found ${Object.keys(permissions).length} roles.`, 'success');
                    
                    // Show current Finance Executive NCD Series permissions
                    const financeExec = permissions['Finance Executive'];
                    if (financeExec && financeExec.ncdSeries) {
                        log(`Finance Executive NCD Series permissions: ${JSON.stringify(financeExec.ncdSeries)}`);
                    }
                    
                    return permissions;
                } else {
                    log(`Failed to get permissions: ${response.status} ${response.statusText}`, 'error');
                    return null;
                }
            } catch (error) {
                log(`Error getting permissions: ${error.message}`, 'error');
                return null;
            }
        }

        async function testTogglePermission() {
            if (!authToken || !originalPermissions) {
                log('Please login and get permissions first!', 'error');
                return;
            }

            log('Toggling Finance Executive NCD Series View permission...');
            
            try {
                // Toggle the permission
                const updatedPermissions = JSON.parse(JSON.stringify(originalPermissions));
                const currentValue = updatedPermissions['Finance Executive'].ncdSeries.view;
                const newValue = !currentValue;
                updatedPermissions['Finance Executive'].ncdSeries.view = newValue;

                log(`Changing Finance Executive NCD Series View: ${currentValue} â†’ ${newValue}`);

                // Send update to backend
                const response = await fetch('http://localhost:8000/permissions/', {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedPermissions)
                });

                if (response.ok) {
                    const result = await response.json();
                    log(`Permission updated successfully! ${result.message}`, 'success');
                    originalPermissions = updatedPermissions; // Update our local copy
                    return true;
                } else {
                    log(`Failed to update permission: ${response.status} ${response.statusText}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`Error updating permission: ${error.message}`, 'error');
                return false;
            }
        }

        async function testVerifyPersistence() {
            if (!authToken) {
                log('Please login first!', 'error');
                return;
            }

            log('Verifying permission persistence by fetching fresh data...');
            
            try {
                const response = await fetch('http://localhost:8000/permissions/', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const freshPermissions = await response.json();
                    const financeExec = freshPermissions['Finance Executive'];
                    
                    if (financeExec && financeExec.ncdSeries) {
                        const currentValue = financeExec.ncdSeries.view;
                        log(`Fresh data shows Finance Executive NCD Series View: ${currentValue}`, 'success');
                        
                        // Compare with what we expect
                        if (originalPermissions) {
                            const expectedValue = originalPermissions['Finance Executive'].ncdSeries.view;
                            if (currentValue === expectedValue) {
                                log('âœ… PERSISTENCE TEST PASSED! Permission change was saved to database.', 'success');
                            } else {
                                log(`âŒ PERSISTENCE TEST FAILED! Expected: ${expectedValue}, Got: ${currentValue}`, 'error');
                            }
                        }
                    }
                    
                    return true;
                } else {
                    log(`Failed to verify persistence: ${response.status} ${response.statusText}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`Error verifying persistence: ${error.message}`, 'error');
                return false;
            }
        }

        // Auto-run basic tests on page load
        window.addEventListener('load', async () => {
            log('ğŸš€ Starting automated tests...');
            
            if (await testLogin()) {
                await new Promise(resolve => setTimeout(resolve, 500));
                await testGetPermissions();
            }
        });
    </script>
</body>
</html>