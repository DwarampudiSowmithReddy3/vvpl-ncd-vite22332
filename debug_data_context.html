<!DOCTYPE html>
<html>
<head>
    <title>Debug DataContext</title>
</head>
<body>
    <h1>Debug DataContext Logic</h1>
    <div id="results"></div>
    
    <script>
        async function debugDataContext() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Debugging DataContext logic...</p>';
            
            // Step 1: Check if user is authenticated (like DataContext does)
            results.innerHTML += '<h3>Step 1: Check Authentication</h3>';
            
            const savedUser = localStorage.getItem('user');
            const savedToken = localStorage.getItem('token');
            
            if (savedUser && savedToken) {
                const userData = JSON.parse(savedUser);
                results.innerHTML += `<p>‚úÖ User found: ${userData.name} (${userData.role})</p>`;
                results.innerHTML += `<p>‚úÖ Token found: ${savedToken.substring(0, 20)}...</p>`;
                
                // Step 2: Try to connect to API (like DataContext does)
                results.innerHTML += '<h3>Step 2: Connect to API</h3>';
                
                try {
                    // Test series endpoint
                    const seriesResponse = await fetch('http://localhost:8003/api/v1/series/', {
                        headers: { 'Authorization': `Bearer ${savedToken}` }
                    });
                    
                    if (seriesResponse.ok) {
                        const seriesData = await seriesResponse.json();
                        results.innerHTML += `<p>‚úÖ Series API call successful: ${seriesData.length} series</p>`;
                        
                        // Step 3: Transform data (like DataContext does)
                        results.innerHTML += '<h3>Step 3: Transform Data</h3>';
                        
                        const transformedSeries = seriesData.map(s => ({
                            id: s.id,
                            name: s.series_name,
                            seriesCode: s.series_code,
                            interestRate: s.interest_rate,
                            status: s.status,
                            targetAmount: s.targetAmount || s.issue_size,
                            fundsRaised: s.fundsRaised || s.total_subscribed || 0,
                            investors: s.investors || 0
                        }));
                        
                        results.innerHTML += `<p>‚úÖ Data transformation successful: ${transformedSeries.length} series</p>`;
                        
                        // Show transformed data
                        results.innerHTML += '<h4>Transformed Data:</h4>';
                        transformedSeries.forEach((series, index) => {
                            results.innerHTML += `
                                <div style="border: 1px solid #ccc; margin: 5px; padding: 10px;">
                                    <strong>${index + 1}. ${series.name}</strong><br>
                                    Code: ${series.seriesCode}<br>
                                    Status: ${series.status}<br>
                                    Interest Rate: ${series.interestRate}%<br>
                                    Target: ‚Çπ${series.targetAmount?.toLocaleString()}<br>
                                    Funds Raised: ‚Çπ${series.fundsRaised?.toLocaleString()}<br>
                                    Investors: ${series.investors}
                                </div>
                            `;
                        });
                        
                        results.innerHTML += '<p>üéâ DataContext logic should work with this data!</p>';
                        
                    } else {
                        results.innerHTML += `<p>‚ùå Series API call failed: ${seriesResponse.status}</p>`;
                        
                        if (seriesResponse.status === 401) {
                            results.innerHTML += '<p>üîë Token might be expired. Try logging in again.</p>';
                        }
                    }
                    
                } catch (error) {
                    results.innerHTML += `<p>‚ùå API connection error: ${error.message}</p>`;
                }
                
            } else {
                results.innerHTML += '<p>‚ùå No user or token found in localStorage</p>';
                results.innerHTML += '<p>üîë User needs to login first</p>';
                
                // Try to login automatically
                results.innerHTML += '<h3>Auto-Login Test</h3>';
                
                try {
                    const loginResponse = await fetch('http://localhost:8003/api/v1/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: 'admin',
                            password: 'admin123',
                            user_type: 'admin'
                        })
                    });
                    
                    if (loginResponse.ok) {
                        const loginData = await loginResponse.json();
                        results.innerHTML += '<p>‚úÖ Auto-login successful</p>';
                        
                        // Store data
                        localStorage.setItem('token', loginData.access_token);
                        localStorage.setItem('user', JSON.stringify({
                            username: loginData.user_info.username,
                            role: loginData.user_info.role,
                            name: loginData.user_info.full_name,
                            displayRole: loginData.user_info.role,
                            email: loginData.user_info.email,
                            id: loginData.user_info.id
                        }));
                        
                        results.innerHTML += '<p>üîÑ Refresh the page to test DataContext with stored credentials</p>';
                    } else {
                        results.innerHTML += `<p>‚ùå Auto-login failed: ${loginResponse.status}</p>`;
                    }
                } catch (error) {
                    results.innerHTML += `<p>‚ùå Auto-login error: ${error.message}</p>`;
                }
            }
        }
        
        // Run debug on page load
        debugDataContext();
    </script>
</body>
</html>