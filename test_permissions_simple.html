<!DOCTYPE html>
<html>
<head>
    <title>Test Permissions Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        button { padding: 10px 15px; margin: 5px; }
    </style>
</head>
<body>
    <h1>üîß Permissions Fix Test</h1>
    
    <div class="step">
        <h3>Step 1: Login</h3>
        <button onclick="login()">Login as admin</button>
        <div id="loginResult"></div>
    </div>
    
    <div class="step">
        <h3>Step 2: Load Permissions</h3>
        <button onclick="loadPermissions()">Load Permissions</button>
        <div id="loadResult"></div>
    </div>
    
    <div class="step">
        <h3>Step 3: Toggle Permission</h3>
        <button onclick="togglePermission()">Toggle Finance Executive Dashboard Create</button>
        <div id="toggleResult"></div>
    </div>
    
    <div class="step">
        <h3>Step 4: Verify Persistence</h3>
        <button onclick="verifyPersistence()">Check if Change Persisted</button>
        <div id="verifyResult"></div>
    </div>

    <script>
        let token = localStorage.getItem('authToken');
        let permissions = {};

        async function api(endpoint, options = {}) {
            const response = await fetch(`http://localhost:8000${endpoint}`, {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                },
                ...options
            });
            return response.json();
        }

        async function login() {
            try {
                const result = await api('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                token = result.access_token;
                localStorage.setItem('authToken', token);
                document.getElementById('loginResult').innerHTML = '<div class="success">‚úÖ Login successful!</div>';
            } catch (error) {
                document.getElementById('loginResult').innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        async function loadPermissions() {
            try {
                permissions = await api('/permissions/');
                const current = permissions['Finance Executive'].dashboard.create;
                document.getElementById('loadResult').innerHTML = `<div class="success">‚úÖ Loaded! Finance Executive dashboard create: ${current}</div>`;
            } catch (error) {
                document.getElementById('loadResult').innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        async function togglePermission() {
            try {
                const oldValue = permissions['Finance Executive'].dashboard.create;
                const newValue = !oldValue;
                
                permissions['Finance Executive'].dashboard.create = newValue;
                
                await api('/permissions/', {
                    method: 'PUT',
                    body: JSON.stringify(permissions)
                });
                
                document.getElementById('toggleResult').innerHTML = `<div class="success">‚úÖ Toggled! ${oldValue} ‚Üí ${newValue}</div>`;
            } catch (error) {
                document.getElementById('toggleResult').innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        async function verifyPersistence() {
            try {
                const freshPermissions = await api('/permissions/');
                const currentValue = freshPermissions['Finance Executive'].dashboard.create;
                const expectedValue = permissions['Finance Executive'].dashboard.create;
                
                if (currentValue === expectedValue) {
                    document.getElementById('verifyResult').innerHTML = `<div class="success">‚úÖ PERSISTENCE WORKS! Value: ${currentValue}</div>`;
                } else {
                    document.getElementById('verifyResult').innerHTML = `<div class="error">‚ùå PERSISTENCE FAILED! Expected: ${expectedValue}, Got: ${currentValue}</div>`;
                }
            } catch (error) {
                document.getElementById('verifyResult').innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>