<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Permission Toggle</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        #log { background: #f5f5f5; padding: 10px; height: 300px; overflow-y: scroll; }
    </style>
</head>
<body>
    <h1>Permission System Test</h1>
    
    <div class="test-section">
        <h3>Step 1: Check Backend Status</h3>
        <button onclick="checkBackend()">Check Backend</button>
        <div id="backend-status"></div>
    </div>
    
    <div class="test-section">
        <h3>Step 2: Test Permission Update (Requires Login)</h3>
        <p>You need to be logged in as Super Admin in the main app first!</p>
        <button onclick="testPermissionUpdate()">Test Permission Update</button>
        <div id="permission-status"></div>
    </div>
    
    <div class="test-section">
        <h3>Step 3: View Current Permissions</h3>
        <button onclick="loadPermissions()">Load Permissions</button>
        <div id="permissions-display"></div>
    </div>
    
    <div class="test-section">
        <h3>Debug Log</h3>
        <button onclick="clearLog()">Clear Log</button>
        <div id="log"></div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function checkBackend() {
            const statusDiv = document.getElementById('backend-status');
            log('üîç Checking backend status...');
            
            try {
                const response = await fetch('http://localhost:8003/docs');
                if (response.ok) {
                    statusDiv.innerHTML = '<span class="success">‚úÖ Backend is running</span>';
                    log('‚úÖ Backend is running');
                    
                    // Test permission endpoints
                    await testEndpoints();
                } else {
                    statusDiv.innerHTML = '<span class="error">‚ùå Backend error</span>';
                    log('‚ùå Backend error: ' + response.status);
                }
            } catch (error) {
                statusDiv.innerHTML = '<span class="error">‚ùå Backend not accessible</span>';
                log('‚ùå Backend not accessible: ' + error.message);
            }
        }
        
        async function testEndpoints() {
            const endpoints = [
                '/api/v1/admin/permissions',
                '/api/v1/admin/permissions-data',
                '/api/v1/admin/public/permissions'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`http://localhost:8003${endpoint}`);
                    if (response.status === 404) {
                        log(`‚ùå ${endpoint} - NOT FOUND (restart backend)`);
                    } else if (response.status === 403 || response.status === 401) {
                        log(`‚úÖ ${endpoint} - Requires auth (endpoint exists)`);
                    } else if (response.status === 200) {
                        log(`‚úÖ ${endpoint} - Working`);
                    } else {
                        log(`‚ö†Ô∏è ${endpoint} - Status: ${response.status}`);
                    }
                } catch (error) {
                    log(`‚ùå ${endpoint} - Error: ${error.message}`);
                }
            }
        }
        
        async function testPermissionUpdate() {
            const statusDiv = document.getElementById('permission-status');
            log('üîÑ Testing permission update...');
            
            // Get token from localStorage (from main app)
            const token = localStorage.getItem('token');
            if (!token) {
                statusDiv.innerHTML = '<span class="error">‚ùå No auth token found. Login in main app first!</span>';
                log('‚ùå No auth token found');
                return;
            }
            
            const testData = {
                role_name: "Admin",
                module_name: "dashboard",
                permission_type: "create",
                is_granted: true
            };
            
            try {
                log('üì§ Sending permission update: ' + JSON.stringify(testData));
                
                const response = await fetch('http://localhost:8003/api/v1/admin/permissions', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(testData)
                });
                
                log(`üì• Response status: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    statusDiv.innerHTML = '<span class="success">‚úÖ Permission updated successfully!</span>';
                    log('‚úÖ Permission updated: ' + JSON.stringify(result));
                } else {
                    const error = await response.json();
                    statusDiv.innerHTML = `<span class="error">‚ùå Update failed: ${error.detail}</span>`;
                    log('‚ùå Update failed: ' + JSON.stringify(error));
                }
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">‚ùå Network error: ${error.message}</span>`;
                log('‚ùå Network error: ' + error.message);
            }
        }
        
        async function loadPermissions() {
            const displayDiv = document.getElementById('permissions-display');
            log('üîÑ Loading permissions...');
            
            try {
                const response = await fetch('http://localhost:8003/api/v1/admin/permissions-data');
                
                if (response.ok) {
                    const permissions = await response.json();
                    displayDiv.innerHTML = `<pre>${JSON.stringify(permissions, null, 2)}</pre>`;
                    log('‚úÖ Permissions loaded successfully');
                } else {
                    displayDiv.innerHTML = `<span class="error">‚ùå Failed to load permissions: ${response.status}</span>`;
                    log('‚ùå Failed to load permissions: ' + response.status);
                }
            } catch (error) {
                displayDiv.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                log('‚ùå Error loading permissions: ' + error.message);
            }
        }
        
        // Auto-check backend on page load
        window.onload = function() {
            log('üöÄ Permission System Test Page Loaded');
            checkBackend();
        };
    </script>
</body>
</html>