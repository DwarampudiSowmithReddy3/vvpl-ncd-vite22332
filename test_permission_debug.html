<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permission Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        #log { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: scroll; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Permission System Debug</h1>
    
    <div class="test-section">
        <h3>Test Permission Update API</h3>
        <p><strong>Instructions:</strong></p>
        <ol>
            <li>Login as Super Admin in your main app first</li>
            <li>Click the test button below</li>
            <li>Check the log for detailed error information</li>
        </ol>
        <button onclick="testPermissionUpdate()">Test Permission Update</button>
    </div>
    
    <div class="test-section">
        <h3>Debug Log</h3>
        <button onclick="clearLog()">Clear Log</button>
        <div id="log"></div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function testPermissionUpdate() {
            log('üîÑ Starting permission update test...');
            
            // Test parameters
            const role = "Admin";
            const module = "dashboard";
            const action = "create";
            const isGranted = true;
            
            log(`üìã Test parameters: role=${role}, module=${module}, action=${action}, isGranted=${isGranted}`);
            
            // Validate parameters
            if (!role || !module || !action || typeof isGranted !== 'boolean') {
                log(`‚ùå Invalid parameters detected`);
                return;
            }
            
            // Get token
            const token = localStorage.getItem('token');
            if (!token) {
                log('‚ùå No authentication token found. Please login in main app first!');
                return;
            }
            
            log('‚úÖ Authentication token found');
            
            // Prepare request data
            const requestData = {
                role_name: String(role),
                module_name: String(module),
                permission_type: String(action),
                is_granted: Boolean(isGranted)
            };
            
            log('üì§ Request data: ' + JSON.stringify(requestData, null, 2));
            
            try {
                log('üåê Making API call...');
                
                const response = await fetch('http://localhost:8003/api/v1/admin/permissions', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                log(`üì• Response status: ${response.status} ${response.statusText}`);
                log(`üì• Response headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log('‚úÖ SUCCESS! Response: ' + JSON.stringify(result, null, 2));
                } else {
                    let errorMessage;
                    try {
                        const errorData = await response.json();
                        errorMessage = JSON.stringify(errorData, null, 2);
                    } catch (parseError) {
                        errorMessage = await response.text();
                    }
                    log(`‚ùå API Error: ${errorMessage}`);
                }
                
            } catch (error) {
                log(`‚ùå Network Error: ${error.message}`);
                log(`‚ùå Error stack: ${error.stack}`);
            }
        }
        
        // Auto-start test
        window.onload = function() {
            log('üöÄ Permission Debug Test Page Loaded');
            log('üí° Click "Test Permission Update" to start debugging');
        };
    </script>
</body>
</html>