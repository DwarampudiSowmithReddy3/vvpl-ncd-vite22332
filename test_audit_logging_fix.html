<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Audit Logging Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Test Audit Logging Fix</h1>
    
    <div class="test-section">
        <h3>Step 1: Login</h3>
        <button onclick="testLogin()">Login as Admin</button>
        <div id="loginResult"></div>
    </div>
    
    <div class="test-section">
        <h3>Step 2: Create Test User (Should Create Audit Log)</h3>
        <button onclick="testCreateUser()">Create Test User</button>
        <div id="createUserResult"></div>
    </div>
    
    <div class="test-section">
        <h3>Step 3: Update Test User (Should Create Audit Log)</h3>
        <button onclick="testUpdateUser()">Update Test User</button>
        <div id="updateUserResult"></div>
    </div>
    
    <div class="test-section">
        <h3>Step 4: Delete Test User (Should Create Audit Log)</h3>
        <button onclick="testDeleteUser()">Delete Test User</button>
        <div id="deleteUserResult"></div>
    </div>
    
    <div class="test-section">
        <h3>Step 5: Check Audit Logs</h3>
        <button onclick="checkAuditLogs()">Get Recent Audit Logs</button>
        <div id="auditLogsResult"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let authToken = null;
        let testUserId = null;

        async function testLogin() {
            const resultDiv = document.getElementById('loginResult');
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    resultDiv.innerHTML = '<span class="success">✅ Login successful!</span>';
                } else {
                    resultDiv.innerHTML = '<span class="error">❌ Login failed</span>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
            }
        }

        async function testCreateUser() {
            const resultDiv = document.getElementById('createUserResult');
            if (!authToken) {
                resultDiv.innerHTML = '<span class="error">❌ Please login first</span>';
                return;
            }

            try {
                // Create user
                const userData = {
                    user_id: 'TEST001',
                    username: 'testuser',
                    full_name: 'Test User',
                    email: 'test@example.com',
                    phone: '+91 9876543210',
                    password: 'test123',
                    role: 'Finance Executive'
                };

                const createResponse = await fetch(`${API_BASE}/users/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                if (createResponse.ok) {
                    const user = await createResponse.json();
                    testUserId = user.id;
                    
                    // Create audit log
                    const auditData = {
                        action: 'Created User',
                        admin_name: 'Test Admin',
                        admin_role: 'Admin',
                        details: `Created new user "${userData.username}" (${userData.full_name}) with role "${userData.role}"`,
                        entity_type: 'User',
                        entity_id: userData.username,
                        changes: {
                            userId: userData.user_id,
                            username: userData.username,
                            fullName: userData.full_name,
                            role: userData.role,
                            email: userData.email,
                            phone: userData.phone,
                            action: 'user_created'
                        }
                    };

                    const auditResponse = await fetch(`${API_BASE}/audit/`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(auditData)
                    });

                    if (auditResponse.ok) {
                        resultDiv.innerHTML = '<span class="success">✅ User created and audit log added!</span>';
                    } else {
                        resultDiv.innerHTML = '<span class="error">❌ User created but audit log failed</span>';
                    }
                } else {
                    const error = await createResponse.text();
                    resultDiv.innerHTML = `<span class="error">❌ User creation failed: ${error}</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
            }
        }

        async function testUpdateUser() {
            const resultDiv = document.getElementById('updateUserResult');
            if (!authToken || !testUserId) {
                resultDiv.innerHTML = '<span class="error">❌ Please create user first</span>';
                return;
            }

            try {
                // Update user
                const updateData = {
                    full_name: 'Updated Test User'
                };

                const updateResponse = await fetch(`${API_BASE}/users/${testUserId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (updateResponse.ok) {
                    // Create audit log
                    const auditData = {
                        action: 'Updated User',
                        admin_name: 'Test Admin',
                        admin_role: 'Admin',
                        details: `Updated full name for user "testuser"`,
                        entity_type: 'User',
                        entity_id: 'testuser',
                        changes: {
                            fields: ['full name'],
                            userId: 'TEST001',
                            userFullName: 'Updated Test User'
                        }
                    };

                    const auditResponse = await fetch(`${API_BASE}/audit/`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(auditData)
                    });

                    if (auditResponse.ok) {
                        resultDiv.innerHTML = '<span class="success">✅ User updated and audit log added!</span>';
                    } else {
                        resultDiv.innerHTML = '<span class="error">❌ User updated but audit log failed</span>';
                    }
                } else {
                    const error = await updateResponse.text();
                    resultDiv.innerHTML = `<span class="error">❌ User update failed: ${error}</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
            }
        }

        async function testDeleteUser() {
            const resultDiv = document.getElementById('deleteUserResult');
            if (!authToken || !testUserId) {
                resultDiv.innerHTML = '<span class="error">❌ Please create user first</span>';
                return;
            }

            try {
                // Delete user
                const deleteResponse = await fetch(`${API_BASE}/users/${testUserId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (deleteResponse.ok) {
                    // Create audit log
                    const auditData = {
                        action: 'Deleted User',
                        admin_name: 'Test Admin',
                        admin_role: 'Admin',
                        details: `Deleted user "testuser" (Updated Test User)`,
                        entity_type: 'User',
                        entity_id: 'testuser',
                        changes: {
                            userId: 'TEST001',
                            username: 'testuser',
                            fullName: 'Updated Test User',
                            role: 'Finance Executive',
                            action: 'user_deleted'
                        }
                    };

                    const auditResponse = await fetch(`${API_BASE}/audit/`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(auditData)
                    });

                    if (auditResponse.ok) {
                        resultDiv.innerHTML = '<span class="success">✅ User deleted and audit log added!</span>';
                    } else {
                        resultDiv.innerHTML = '<span class="error">❌ User deleted but audit log failed</span>';
                    }
                } else {
                    const error = await deleteResponse.text();
                    resultDiv.innerHTML = `<span class="error">❌ User deletion failed: ${error}</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
            }
        }

        async function checkAuditLogs() {
            const resultDiv = document.getElementById('auditLogsResult');
            if (!authToken) {
                resultDiv.innerHTML = '<span class="error">❌ Please login first</span>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/audit/?limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const logs = await response.json();
                    let html = `<span class="success">✅ Retrieved ${logs.length} audit logs:</span><br><pre>`;
                    
                    logs.forEach(log => {
                        html += `${log.timestamp}: ${log.action} by ${log.admin_name} - ${log.details}\n`;
                    });
                    
                    html += '</pre>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<span class="error">❌ Failed to get audit logs</span>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">❌ Error: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>