<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Permission Toggle Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        .step {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .console-monitor {
            background: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ Simple Permission Toggle Test</h1>
        <p><strong>Purpose:</strong> Test permission toggles without infinite loops</p>
        
        <div class="step">
            <h3>ğŸ“‹ TESTING STEPS:</h3>
            <ol>
                <li><strong>Clear Console:</strong> <button onclick="console.clear()">Clear Console</button></li>
                <li><strong>Login:</strong> Use admin/admin123</li>
                <li><strong>Navigate:</strong> Administrator â†’ Permissions tab</li>
                <li><strong>Toggle:</strong> Click ONE permission toggle</li>
                <li><strong>Watch Console:</strong> Look for patterns below</li>
            </ol>
        </div>

        <div class="step">
            <h3>âœ… GOOD PATTERNS (What you SHOULD see):</h3>
            <div class="console-monitor">
ğŸ” addAuditLog called with: Updated Permissions<br>
ğŸ” Added audit log to state, total logs: 1<br>
âœ… addAuditLog completed (database save disabled)<br>
âœ… Permission toggled successfully: Finance Executive.dashboard.view false â†’ true<br>
            </div>
        </div>

        <div class="step">
            <h3>âŒ BAD PATTERNS (What you should NOT see):</h3>
            <div class="console-monitor">
ğŸ”„ Loading audit logs from database...<br>
ğŸ”„ Loading audit logs from database...<br>
ğŸ”„ Loading audit logs from database...<br>
(repeating continuously)<br>
<br>
OR<br>
<br>
ğŸ” addAuditLog called with: Updated Permissions<br>
ğŸ” addAuditLog called with: Updated Permissions<br>
ğŸ” addAuditLog called with: Updated Permissions<br>
(repeating continuously)
            </div>
        </div>

        <div class="step">
            <h3>ğŸ§ª QUICK TESTS:</h3>
            <button onclick="testConsoleCount()">Count Console Messages</button>
            <button onclick="testLocalStorage()">Check LocalStorage</button>
            <button onclick="simulatePermissionToggle()">Simulate Toggle</button>
        </div>

        <div id="testResults"></div>
    </div>

    <script>
        let messageCount = 0;
        let originalConsoleLog = console.log;

        // Override console.log to count messages
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            messageCount++;
            
            const message = args.join(' ');
            
            // Check for infinite loop patterns
            if (message.includes('Loading audit logs') && messageCount > 5) {
                alert('ğŸš¨ INFINITE LOOP DETECTED: Too many audit log loading messages!');
            }
            
            if (message.includes('addAuditLog called') && messageCount > 10) {
                alert('ğŸš¨ INFINITE LOOP DETECTED: addAuditLog being called too many times!');
            }
        };

        function testConsoleCount() {
            const results = document.getElementById('testResults');
            results.innerHTML = `
                <div class="test-container">
                    <h4>ğŸ“Š Console Message Count</h4>
                    <p><strong>Total messages since page load:</strong> ${messageCount}</p>
                    <p><strong>Status:</strong> ${messageCount > 20 ? '<span class="error">âŒ Too many messages (possible infinite loop)</span>' : '<span class="success">âœ… Normal message count</span>'}</p>
                </div>
            `;
        }

        function testLocalStorage() {
            const auditLogs = localStorage.getItem('auditLogs');
            const authToken = localStorage.getItem('authToken');
            const results = document.getElementById('testResults');
            
            results.innerHTML = `
                <div class="test-container">
                    <h4>ğŸ’¾ LocalStorage Check</h4>
                    <p><strong>Auth Token:</strong> ${authToken ? 'âœ… Present' : 'âŒ Missing'}</p>
                    <p><strong>Audit Logs:</strong> ${auditLogs ? 'âœ… Present (' + JSON.parse(auditLogs).length + ' logs)' : 'âŒ Missing'}</p>
                </div>
            `;
        }

        function simulatePermissionToggle() {
            console.log('ğŸ§ª SIMULATED: Permission toggle clicked');
            console.log('ğŸ” addAuditLog called with: Updated Permissions');
            console.log('ğŸ” Added audit log to state, total logs: 1');
            console.log('âœ… addAuditLog completed (database save disabled)');
            console.log('âœ… Permission toggled successfully: Finance Executive.dashboard.view false â†’ true');
            
            const results = document.getElementById('testResults');
            results.innerHTML = `
                <div class="test-container">
                    <h4>ğŸ§ª Simulation Complete</h4>
                    <p class="success">âœ… Simulated permission toggle - check console for the expected pattern</p>
                </div>
            `;
        }

        // Auto-clear message count every 30 seconds
        setInterval(() => {
            if (messageCount > 0) {
                console.log(`ğŸ“Š Message count reset: ${messageCount} messages in last 30 seconds`);
                messageCount = 0;
            }
        }, 30000);

        console.log('ğŸ§ª Permission Toggle Test Page Ready');
        console.log('ğŸ” Monitoring console for infinite loop patterns...');
    </script>
</body>
</html>