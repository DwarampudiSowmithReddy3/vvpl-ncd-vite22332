<!DOCTYPE html>
<html>
<head>
    <title>Final Frontend Audit Log Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .log-details { max-width: 300px; word-wrap: break-word; }
    </style>
</head>
<body>
    <h1>üéØ Final Frontend Audit Log Integration Test</h1>
    
    <div class="info">
        <h3>Test Status:</h3>
        <p>This test verifies that the frontend can successfully load audit logs from the MySQL backend.</p>
    </div>
    
    <button onclick="testFrontendAuditIntegration()">üîÑ Test Frontend Integration</button>
    <button onclick="testCreateAndVerify()">üìù Test Create & Verify</button>
    
    <div id="results"></div>
    
    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
            console.log(message);
        }
        
        async function testFrontendAuditIntegration() {
            log('üîÑ Testing frontend audit log integration...', 'info');
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    log('‚ùå No token found. Please login in the main application first.', 'error');
                    return;
                }
                
                // Test 1: Load audit logs directly from API
                log('1. üì° Loading audit logs from backend API...', 'info');
                const response = await fetch('http://localhost:8003/api/v1/admin/audit-logs?limit=50', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const logs = await response.json();
                    log(`‚úÖ Successfully loaded ${logs.length} audit logs from backend`, 'success');
                    
                    // Test 2: Verify data structure matches frontend expectations
                    log('2. üîç Verifying data structure...', 'info');
                    if (logs.length > 0) {
                        const sampleLog = logs[0];
                        const requiredFields = ['id', 'adminName', 'adminRole', 'action', 'entityId', 'entityType', 'details', 'timestamp'];
                        const missingFields = requiredFields.filter(field => !(field in sampleLog));
                        
                        if (missingFields.length === 0) {
                            log('‚úÖ All required fields present in audit log data', 'success');
                            
                            // Test 3: Display sample logs in table format
                            log('3. üìã Displaying sample audit logs...', 'info');
                            displayAuditLogsTable(logs.slice(0, 10)); // Show first 10 logs
                            
                            // Test 4: Verify different action types
                            log('4. üéØ Analyzing action types...', 'info');
                            const actionTypes = [...new Set(logs.map(log => log.action))];
                            log(`‚úÖ Found ${actionTypes.length} different action types: ${actionTypes.join(', ')}`, 'success');
                            
                            // Test 5: Verify timestamp format
                            log('5. üìÖ Verifying timestamp format...', 'info');
                            const sampleTimestamp = new Date(sampleLog.timestamp);
                            if (!isNaN(sampleTimestamp.getTime())) {
                                log(`‚úÖ Timestamp format is valid: ${sampleTimestamp.toLocaleString()}`, 'success');
                            } else {
                                log('‚ùå Invalid timestamp format', 'error');
                            }
                            
                            // Final summary
                            log('üéâ FRONTEND INTEGRATION TEST PASSED!', 'success');
                            log(`‚úÖ ${logs.length} audit logs loaded successfully`, 'success');
                            log('‚úÖ Data structure matches frontend requirements', 'success');
                            log('‚úÖ Ready for use in Administrator page', 'success');
                            
                        } else {
                            log(`‚ùå Missing required fields: ${missingFields.join(', ')}`, 'error');
                        }
                    } else {
                        log('‚ö†Ô∏è No audit logs found in database', 'info');
                    }
                    
                } else {
                    log(`‚ùå Failed to load audit logs: ${response.status}`, 'error');
                    const errorText = await response.text();
                    log(`Error details: ${errorText}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function testCreateAndVerify() {
            log('üîÑ Testing create audit log and verify...', 'info');
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    log('‚ùå No token found. Please login first.', 'error');
                    return;
                }
                
                // Create a test audit log
                const testLog = {
                    action: 'Frontend Test',
                    entityType: 'Test',
                    entityId: 'frontend_test_' + Date.now(),
                    details: 'Test audit log created from frontend integration test',
                    userAgent: navigator.userAgent
                };
                
                log('üìù Creating test audit log...', 'info');
                const createResponse = await fetch('http://localhost:8003/api/v1/admin/audit-logs', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testLog)
                });
                
                if (createResponse.ok) {
                    const result = await createResponse.json();
                    log(`‚úÖ Test audit log created successfully (ID: ${result.log_id})`, 'success');
                    
                    // Wait a moment then verify it appears in the list
                    setTimeout(async () => {
                        log('üîç Verifying test log appears in list...', 'info');
                        const verifyResponse = await fetch('http://localhost:8003/api/v1/admin/audit-logs?limit=5', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (verifyResponse.ok) {
                            const logs = await verifyResponse.json();
                            const testLogFound = logs.find(log => log.entityId === testLog.entityId);
                            
                            if (testLogFound) {
                                log('‚úÖ Test log found in database!', 'success');
                                log(`üìã Log details: ${testLogFound.adminName} - ${testLogFound.action}`, 'info');
                            } else {
                                log('‚ùå Test log not found in database', 'error');
                            }
                        }
                    }, 1000);
                    
                } else {
                    log(`‚ùå Failed to create test audit log: ${createResponse.status}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        function displayAuditLogsTable(logs) {
            const results = document.getElementById('results');
            
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Timestamp</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Entity</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    ${logs.map(log => `
                        <tr>
                            <td>${log.id}</td>
                            <td>${new Date(log.timestamp).toLocaleString()}</td>
                            <td>${log.adminName}<br><small>${log.adminRole}</small></td>
                            <td><strong>${log.action}</strong></td>
                            <td>${log.entityType}<br><small>${log.entityId}</small></td>
                            <td class="log-details">${log.details}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            
            results.appendChild(table);
        }
        
        // Auto-test on page load if token exists
        window.onload = function() {
            const token = localStorage.getItem('token');
            if (token) {
                log('‚úÖ Token found in localStorage', 'success');
                log('üí° Ready to test frontend audit log integration', 'info');
            } else {
                log('‚ö†Ô∏è No token found. Please login in the main application first.', 'error');
            }
        };
    </script>
</body>
</html>