<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Permission Network Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .critical {
            background: #ffebee;
            border: 2px solid #f44336;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success {
            background: #e8f5e8;
            border: 2px solid #4CAF50;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .warning {
            background: #fff3cd;
            border: 2px solid #ff9800;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        button:hover {
            background: #1976D2;
        }
        .test-button {
            background: #4CAF50;
        }
        .test-button:hover {
            background: #45a049;
        }
        .code {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        #networkLogs {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Permission Network Debug Test</h1>
    
    <div class="critical">
        <h2>üö® NETWORK TAB TRUTH TEST</h2>
        <p><strong>Problem:</strong> Permission toggles work in UI but no network request appears in Network tab.</p>
        <p><strong>This means:</strong> The button click is NOT calling the API - it's only updating React state!</p>
    </div>

    <div class="debug-container">
        <h2>üìã Step-by-Step Debug Instructions</h2>
        
        <div class="warning">
            <h3>üîß BEFORE Testing:</h3>
            <ol>
                <li>Open Developer Tools (F12)</li>
                <li>Go to <strong>Network</strong> tab</li>
                <li>Clear all logs (üö´ button)</li>
                <li>Make sure you're logged in as admin/admin123</li>
            </ol>
        </div>
        
        <div class="success">
            <h3>üß™ Test Steps:</h3>
            <ol>
                <li>Click the test button below to make a direct API call</li>
                <li>Check Network tab - you should see a PUT request to /permissions/</li>
                <li>Then go to your app and click a permission toggle</li>
                <li>Check Network tab again - if NO request appears, the button is broken!</li>
            </ol>
        </div>
    </div>

    <div class="debug-container">
        <h2>üß™ Direct API Test</h2>
        <p>This will make a direct API call to test if the backend is working:</p>
        
        <button class="test-button" onclick="testDirectAPI()">üöÄ Test Direct API Call</button>
        <button onclick="testGetPermissions()">üì• Test Get Permissions</button>
        <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        
        <div id="apiResults"></div>
    </div>

    <div class="debug-container">
        <h2>üìä Network Request Monitor</h2>
        <p>This will monitor all network requests and show you what's happening:</p>
        
        <button onclick="startNetworkMonitoring()">üîç Start Network Monitoring</button>
        <button onclick="stopNetworkMonitoring()">‚èπÔ∏è Stop Monitoring</button>
        
        <div id="networkLogs"></div>
    </div>

    <div class="debug-container">
        <h2>üîß Manual Debug Commands</h2>
        <p>Copy and paste these into your browser console:</p>
        
        <div class="code">// Check if AuthContext updatePermissions is being called
window.debugPermissions = true;

// Override console.log to catch permission logs
const originalLog = console.log;
console.log = function(...args) {
    if (args[0] && args[0].includes('Permission')) {
        document.getElementById('networkLogs').innerHTML += 
            `<div class="log">üîç ${args.join(' ')}</div>`;
    }
    originalLog.apply(console, args);
};

// Test the permission toggle function directly
// (Run this in your app's console, not here)
if (window.authContext && window.authContext.updatePermissions) {
    console.log('‚úÖ AuthContext updatePermissions function exists');
} else {
    console.log('‚ùå AuthContext updatePermissions function NOT found');
}</div>
    </div>

    <script>
        let networkMonitoring = false;
        let originalFetch = window.fetch;
        
        function addLog(message, type = 'info') {
            const logs = document.getElementById('networkLogs');
            const logClass = type === 'error' ? 'log' : type === 'success' ? 'log' : 'log';
            logs.innerHTML += `<div class="${logClass}">[${new Date().toLocaleTimeString()}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('networkLogs').innerHTML = '';
            document.getElementById('apiResults').innerHTML = '';
        }
        
        function startNetworkMonitoring() {
            if (networkMonitoring) return;
            
            networkMonitoring = true;
            addLog('üîç Network monitoring started...', 'success');
            
            // Override fetch to monitor requests
            window.fetch = function(...args) {
                const url = args[0];
                const options = args[1] || {};
                
                addLog(`üì° FETCH REQUEST: ${options.method || 'GET'} ${url}`);
                
                if (url.includes('/permissions/')) {
                    addLog(`üéØ PERMISSION API CALL DETECTED!`, 'success');
                    addLog(`üìã Method: ${options.method || 'GET'}`);
                    addLog(`üìã Headers: ${JSON.stringify(options.headers || {})}`);
                    if (options.body) {
                        addLog(`üìã Body: ${options.body.substring(0, 200)}...`);
                    }
                }
                
                return originalFetch.apply(this, args)
                    .then(response => {
                        addLog(`‚úÖ RESPONSE: ${response.status} ${response.statusText} for ${url}`);
                        return response;
                    })
                    .catch(error => {
                        addLog(`‚ùå ERROR: ${error.message} for ${url}`, 'error');
                        throw error;
                    });
            };
        }
        
        function stopNetworkMonitoring() {
            networkMonitoring = false;
            window.fetch = originalFetch;
            addLog('‚èπÔ∏è Network monitoring stopped', 'warning');
        }
        
        async function testDirectAPI() {
            const results = document.getElementById('apiResults');
            results.innerHTML = '<h3>üß™ Direct API Test Results:</h3>';
            
            const token = localStorage.getItem('authToken');
            if (!token) {
                results.innerHTML += '<div class="critical">‚ùå No auth token found! Please login first.</div>';
                return;
            }
            
            try {
                // First get current permissions
                addLog('üîÑ Getting current permissions...');
                const getResponse = await fetch('http://localhost:8000/permissions/', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!getResponse.ok) {
                    throw new Error(`GET failed: ${getResponse.status}`);
                }
                
                const currentPermissions = await getResponse.json();
                addLog(`‚úÖ Got ${Object.keys(currentPermissions).length} roles`);
                
                // Toggle Finance Executive NCD Series view
                const fe = currentPermissions['Finance Executive'];
                if (fe && fe.ncdSeries) {
                    const oldValue = fe.ncdSeries.view;
                    const newValue = !oldValue;
                    
                    addLog(`üîÑ Toggling Finance Executive NCD Series view: ${oldValue} ‚Üí ${newValue}`);
                    
                    // Update the permission
                    currentPermissions['Finance Executive']['ncdSeries']['view'] = newValue;
                    
                    // Send PUT request
                    const putResponse = await fetch('http://localhost:8000/permissions/', {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(currentPermissions)
                    });
                    
                    if (!putResponse.ok) {
                        throw new Error(`PUT failed: ${putResponse.status}`);
                    }
                    
                    const putResult = await putResponse.json();
                    addLog(`‚úÖ PUT successful: ${putResult.message}`, 'success');
                    
                    results.innerHTML += '<div class="success">‚úÖ Direct API test PASSED! Backend is working correctly.</div>';
                    results.innerHTML += '<div class="warning">‚ö†Ô∏è If this works but your app button doesn\'t, the problem is in your React component!</div>';
                    
                } else {
                    throw new Error('Finance Executive or ncdSeries not found in permissions');
                }
                
            } catch (error) {
                addLog(`‚ùå Direct API test failed: ${error.message}`, 'error');
                results.innerHTML += `<div class="critical">‚ùå Direct API test FAILED: ${error.message}</div>`;
            }
        }
        
        async function testGetPermissions() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                addLog('‚ùå No auth token found!', 'error');
                return;
            }
            
            try {
                addLog('üîÑ Testing GET permissions...');
                const response = await fetch('http://localhost:8000/permissions/', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addLog(`‚úÖ GET permissions successful: ${Object.keys(data).length} roles`, 'success');
                    
                    const fe = data['Finance Executive'];
                    if (fe && fe.ncdSeries) {
                        addLog(`üìã Finance Executive NCD Series view: ${fe.ncdSeries.view}`);
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                addLog(`‚ùå GET permissions failed: ${error.message}`, 'error');
            }
        }
        
        // Auto-start monitoring
        setTimeout(() => {
            startNetworkMonitoring();
            addLog('üöÄ Debug page loaded. Network monitoring active.');
            addLog('üìã Now go to your app and click a permission toggle button.');
            addLog('üìã If no permission API calls appear here, the button is NOT calling the API!');
        }, 1000);
    </script>
</body>
</html>