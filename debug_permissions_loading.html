<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Permissions Loading</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .test-button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .test-results {
            margin-top: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .error {
            color: #dc2626;
        }
        
        .success {
            color: #059669;
        }
        
        .warning {
            color: #d97706;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug: Why Permissions Revert After Refresh</h1>
        
        <p><strong>Problem:</strong> Permissions update correctly, but after page refresh they go back to defaults.</p>
        <p><strong>Hypothesis:</strong> The loadPermissions() function is failing silently during page refresh.</p>
        
        <div>
            <button class="test-button" onclick="testLoginAndPermissions()">1. Test Login + Load Permissions</button>
            <button class="test-button" onclick="testPermissionsAPI()">2. Test Permissions API Directly</button>
            <button class="test-button" onclick="simulatePageRefresh()">3. Simulate Page Refresh Flow</button>
            <button class="test-button" onclick="checkTokenValidity()">4. Check Token Validity</button>
        </div>
        
        <div id="testResults" class="test-results"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            let className = 'success';
            if (type === 'error') className = 'error';
            if (type === 'warning') className = 'warning';
            
            resultsDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        async function testLoginAndPermissions() {
            try {
                document.getElementById('testResults').innerHTML = '';
                log('üß™ Testing Login + Load Permissions Flow...');
                
                // Step 1: Login
                log('üîê Step 1: Logging in...');
                const loginResponse = await fetch('http://localhost:8000/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                
                if (!loginResponse.ok) {
                    throw new Error(`Login failed: ${loginResponse.status}`);
                }
                
                const loginData = await loginResponse.json();
                const token = loginData.access_token;
                log(`‚úÖ Login successful, token: ${token.substring(0, 20)}...`);
                
                // Step 2: Get current user
                log('üë§ Step 2: Getting current user...');
                const userResponse = await fetch('http://localhost:8000/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!userResponse.ok) {
                    throw new Error(`Get user failed: ${userResponse.status}`);
                }
                
                const userData = await userResponse.json();
                log(`‚úÖ User loaded: ${userData.username} (${userData.role})`);
                
                // Step 3: Load permissions (this is what fails!)
                log('üîë Step 3: Loading permissions...');
                const permissionsResponse = await fetch('http://localhost:8000/permissions/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!permissionsResponse.ok) {
                    log(`‚ùå PERMISSIONS API FAILED: ${permissionsResponse.status}`, 'error');
                    log(`‚ùå This is why permissions revert to defaults!`, 'error');
                    const errorText = await permissionsResponse.text();
                    log(`‚ùå Error details: ${errorText}`, 'error');
                    return;
                }
                
                const permissions = await permissionsResponse.json();
                log(`‚úÖ Permissions loaded successfully!`);
                log(`‚úÖ Got permissions for ${Object.keys(permissions).length} roles`);
                log(`‚úÖ Super Admin administrator: ${JSON.stringify(permissions['Super Admin']['administrator'])}`);
                
                log('üéâ ALL STEPS SUCCESSFUL - The API is working!');
                log('üîç If permissions still revert, the issue is in the frontend React code.');
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
            }
        }
        
        async function testPermissionsAPI() {
            try {
                document.getElementById('testResults').innerHTML = '';
                log('üß™ Testing Permissions API Directly...');
                
                // Get token from localStorage (if exists)
                const existingToken = localStorage.getItem('authToken');
                let token = existingToken;
                
                if (!token) {
                    log('üîê No existing token, logging in...');
                    const loginResponse = await fetch('http://localhost:8000/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: 'admin', password: 'admin123' })
                    });
                    const loginData = await loginResponse.json();
                    token = loginData.access_token;
                    localStorage.setItem('authToken', token);
                } else {
                    log(`üîë Using existing token: ${token.substring(0, 20)}...`);
                }
                
                // Test permissions API
                log('üì° Calling /permissions/ endpoint...');
                const response = await fetch('http://localhost:8000/permissions/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                log(`üì° Response status: ${response.status}`);
                log(`üì° Response headers: ${JSON.stringify(Object.fromEntries(response.headers))}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå API call failed: ${errorText}`, 'error');
                    
                    if (response.status === 401) {
                        log(`‚ùå TOKEN IS INVALID OR EXPIRED!`, 'error');
                        log(`‚ùå This is why loadPermissions() fails on page refresh!`, 'error');
                    }
                    return;
                }
                
                const permissions = await response.json();
                log(`‚úÖ Permissions API working correctly!`);
                log(`‚úÖ Received ${Object.keys(permissions).length} roles`);
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
            }
        }
        
        async function simulatePageRefresh() {
            try {
                document.getElementById('testResults').innerHTML = '';
                log('üß™ Simulating Page Refresh Flow...');
                
                // This simulates what happens when the page refreshes
                log('üîÑ Step 1: Check for existing token...');
                const token = localStorage.getItem('authToken');
                
                if (!token) {
                    log('‚ùå No token found - user would see login page', 'warning');
                    return;
                }
                
                log(`‚úÖ Token found: ${token.substring(0, 20)}...`);
                
                // Step 2: Validate token by getting current user
                log('üîÑ Step 2: Validating token with /auth/me...');
                const userResponse = await fetch('http://localhost:8000/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!userResponse.ok) {
                    log(`‚ùå Token validation failed: ${userResponse.status}`, 'error');
                    log(`‚ùå This would cause logout and permissions reset`, 'error');
                    return;
                }
                
                const userData = await userResponse.json();
                log(`‚úÖ Token valid, user: ${userData.username} (${userData.role})`);
                
                // Step 3: Load permissions (the critical step)
                log('üîÑ Step 3: Loading permissions...');
                const permissionsResponse = await fetch('http://localhost:8000/permissions/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!permissionsResponse.ok) {
                    log(`‚ùå PERMISSIONS LOADING FAILED: ${permissionsResponse.status}`, 'error');
                    log(`‚ùå THIS IS THE ROOT CAUSE!`, 'error');
                    const errorText = await permissionsResponse.text();
                    log(`‚ùå Error: ${errorText}`, 'error');
                    return;
                }
                
                const permissions = await permissionsResponse.json();
                log(`‚úÖ Permissions loaded successfully on refresh!`);
                log(`‚úÖ Super Admin administrator: ${JSON.stringify(permissions['Super Admin']['administrator'])}`);
                
                log('üéâ PAGE REFRESH FLOW WORKING CORRECTLY!');
                log('üîç If permissions still revert, check React state management.');
                
            } catch (error) {
                log(`‚ùå Simulation failed: ${error.message}`, 'error');
            }
        }
        
        async function checkTokenValidity() {
            try {
                document.getElementById('testResults').innerHTML = '';
                log('üß™ Checking Token Validity...');
                
                const token = localStorage.getItem('authToken');
                if (!token) {
                    log('‚ùå No token in localStorage', 'error');
                    return;
                }
                
                log(`üîë Token: ${token.substring(0, 50)}...`);
                
                // Try to decode JWT (basic check)
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    log(`üìä Token payload: ${JSON.stringify(payload)}`);
                    
                    const now = Math.floor(Date.now() / 1000);
                    if (payload.exp && payload.exp < now) {
                        log(`‚ùå TOKEN EXPIRED! Exp: ${payload.exp}, Now: ${now}`, 'error');
                        log(`‚ùå This is why permissions fail to load!`, 'error');
                    } else {
                        log(`‚úÖ Token not expired`);
                    }
                } catch (e) {
                    log(`‚ö†Ô∏è Could not decode token: ${e.message}`, 'warning');
                }
                
                // Test token with API
                log('üîÑ Testing token with API...');
                const response = await fetch('http://localhost:8000/auth/verify-token', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ Token is valid: ${JSON.stringify(result)}`);
                } else {
                    log(`‚ùå Token validation failed: ${response.status}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Token check failed: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>