<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Audit Logging</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; font-size: 12px; }
        .log { margin: 5px 0; padding: 5px; background: #f9f9f9; border-left: 3px solid #ccc; }
    </style>
</head>
<body>
    <h1>Debug Audit Logging Issue</h1>
    
    <div class="test-section">
        <h3>Test Frontend Integration</h3>
        <p>This will test the exact same flow as the Administrator page</p>
        <button onclick="testFrontendFlow()">Test Complete Flow</button>
        <div id="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        
        function log(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            resultDiv.appendChild(logDiv);
            console.log(message);
        }

        async function testFrontendFlow() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '';
            
            try {
                // Step 1: Login
                log('üîÑ Step 1: Logging in...', 'info');
                const loginResponse = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                
                if (!loginResponse.ok) {
                    log('‚ùå Login failed', 'error');
                    return;
                }
                
                const loginData = await loginResponse.json();
                const authToken = loginData.access_token;
                const user = loginData.user;
                
                log(`‚úÖ Login successful. User: ${user.full_name}, Role: ${user.role}`, 'success');
                
                // Step 2: Create user
                log('üîÑ Step 2: Creating test user...', 'info');
                const userData = {
                    user_id: 'DEBUG001',
                    username: 'debuguser',
                    full_name: 'Debug User',
                    email: 'debug@example.com',
                    phone: '+91 9876543210',
                    password: 'debug123',
                    role: 'Finance Executive'
                };

                const createResponse = await fetch(`${API_BASE}/users/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                if (!createResponse.ok) {
                    const error = await createResponse.text();
                    log(`‚ùå User creation failed: ${error}`, 'error');
                    return;
                }
                
                const newUser = await createResponse.json();
                log(`‚úÖ User created successfully. ID: ${newUser.id}`, 'success');
                
                // Step 3: Create audit log (exactly like Administrator.jsx)
                log('üîÑ Step 3: Creating audit log...', 'info');
                const auditData = {
                    action: 'Created User',
                    admin_name: user.full_name,  // Using full_name like AuthContext does
                    admin_role: user.role,       // Using role like AuthContext does
                    details: `Created new user "${userData.username}" (${userData.full_name}) with role "${userData.role}"`,
                    entity_type: 'User',
                    entity_id: userData.username,
                    changes: {
                        userId: userData.user_id,
                        username: userData.username,
                        fullName: userData.full_name,
                        role: userData.role,
                        email: userData.email,
                        phone: userData.phone,
                        action: 'user_created'
                    }
                };

                log(`üîç Audit data: ${JSON.stringify(auditData, null, 2)}`, 'info');

                const auditResponse = await fetch(`${API_BASE}/audit/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(auditData)
                });

                if (!auditResponse.ok) {
                    const error = await auditResponse.text();
                    log(`‚ùå Audit log creation failed: ${error}`, 'error');
                    return;
                }
                
                const auditResult = await auditResponse.json();
                log(`‚úÖ Audit log created successfully. ID: ${auditResult.id}`, 'success');
                
                // Step 4: Verify audit logs
                log('üîÑ Step 4: Checking recent audit logs...', 'info');
                const logsResponse = await fetch(`${API_BASE}/audit/?limit=5`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (logsResponse.ok) {
                    const logs = await logsResponse.json();
                    log(`‚úÖ Retrieved ${logs.length} recent audit logs:`, 'success');
                    logs.forEach((log, index) => {
                        log(`${index + 1}. ${log.action} by ${log.admin_name} - ${log.details}`, 'info');
                    });
                } else {
                    log('‚ùå Failed to retrieve audit logs', 'error');
                }
                
                // Step 5: Clean up - delete the test user
                log('üîÑ Step 5: Cleaning up test user...', 'info');
                const deleteResponse = await fetch(`${API_BASE}/users/${newUser.id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (deleteResponse.ok) {
                    log('‚úÖ Test user deleted successfully', 'success');
                } else {
                    log('‚ö†Ô∏è Failed to delete test user (not critical)', 'error');
                }
                
                log('üéâ Complete flow test finished!', 'success');
                
            } catch (error) {
                log(`‚ùå Unexpected error: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
    </script>
</body>
</html>